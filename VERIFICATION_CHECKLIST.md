# ä¿®å¤éªŒè¯æ¸…å• âœ…

## ğŸ“‹ å·²å®Œæˆçš„ä¿®æ”¹

### 1. SOAP ä¿¡å°æ ¼å¼ç®€åŒ– âœ…
- [x] æ›´æ”¹æ ¹å…ƒç´ ä» `soap:Envelope` åˆ° `s:Envelope`
- [x] ç§»é™¤ä¸å¿…è¦çš„å‘½åç©ºé—´å£°æ˜ (`xmlns:tds`, `xmlns:trt` ç­‰)
- [x] æ›´æ”¹ Header/Body å‰ç¼€ä» `soap:` åˆ° `s:`
- **æ–‡ä»¶**: `internal/onvif/soap_client.go` è¡Œ ~105-115

### 2. WSSE Header æ”¹è¿› âœ…
- [x] æ·»åŠ  `s:mustUnderstand="1"` å±æ€§åˆ° Security å…ƒç´ 
- [x] æ”¹è¿›å‘½åç©ºé—´å£°æ˜æ ¼å¼
- [x] ç§»é™¤ UsernameToken çš„ `xmlns` å’Œ `u:Id` å±æ€§
- **æ–‡ä»¶**: `internal/onvif/soap_client.go` è¡Œ ~73-90

### 3. Nonce å’Œæ‘˜è¦è®¡ç®—ä¿®å¤ âœ…
- [x] generateNonce() è¿”å› (base64_string, raw_bytes) å…ƒç»„
- [x] æ‘˜è¦è®¡ç®—ä½¿ç”¨åŸå§‹ nonce å­—èŠ‚ï¼ˆä¸æ˜¯ base64 ç¼–ç çš„ï¼‰
- [x] è®¡ç®—é¡ºåº: `SHA1(nonce_bytes + timestamp + password)`
- **æ–‡ä»¶**: `internal/onvif/soap_client.go` è¡Œ ~54-71

### 4. Timestamp æ ¼å¼ âœ…
- [x] Timestamp æ ¼å¼ä¸º `YYYY-MM-DDTHH:MM:SS.000Z`ï¼ˆåŒ…å«æ¯«ç§’ï¼‰
- **æ–‡ä»¶**: `internal/onvif/soap_client.go` è¡Œ ~62

### 5. é”™è¯¯æ—¥å¿—å¢å¼º âœ…
- [x] æ·»åŠ  SOAP è¯·æ±‚ä½“é¢„è§ˆï¼ˆ503/401 æ—¶ï¼‰
- [x] æ·»åŠ  SOAP å“åº”ä½“é¢„è§ˆ
- **æ–‡ä»¶**: `internal/onvif/soap_client.go` è¡Œ ~134-145

---

## ğŸ§ª éªŒè¯æ­¥éª¤

### æ­¥éª¤ 1: ç¼–è¯‘ä»£ç 
```bash
cd /home/jl/ä¸‹è½½/zpip/zpip
go build -o server ./cmd/server/ 2>&1 && echo "âœ… ç¼–è¯‘æˆåŠŸ"
```
**é¢„æœŸ**: ç¼–è¯‘æˆåŠŸï¼Œæ— é”™è¯¯

### æ­¥éª¤ 2: å¿«é€ŸåŠŸèƒ½æµ‹è¯•
```bash
./quick_test.sh 192.168.1.250 8888 admin a123456789
```

**é¢„æœŸè¾“å‡º**:
```
ã€1ï¸âƒ£ è„šæœ¬æ–¹å¼æµ‹è¯•ã€‘
âœ… è„šæœ¬æ–¹å¼æˆåŠŸ (HTTP 200)

ã€2ï¸âƒ£ Go æœåŠ¡æµ‹è¯•ã€‘
âœ… Go æœåŠ¡è¿è¡Œä¸­
âœ… Go æ–¹å¼æˆåŠŸ (è·å–åˆ° Profiles)
```

### æ­¥éª¤ 3: è¯¦ç»†æ—¥å¿—éªŒè¯
å¯åŠ¨ä¸€ä¸ªç»ˆç«¯è¿è¡ŒæœåŠ¡ï¼Œå¦ä¸€ä¸ªç»ˆç«¯æµ‹è¯•:

**ç»ˆç«¯ 1**:
```bash
./server 2>&1 | grep -E "SOAP|GetSystemDateAndTime|GetProfiles|503|â—|âœ…"
```

**ç»ˆç«¯ 2**:
```bash
# ç­‰å¾… 3 ç§’ï¼Œè®©æœåŠ¡å¯åŠ¨
sleep 3

# è°ƒç”¨ API
curl -s http://localhost:8080/api/onvif/devices/192.168.1.250:8888/profiles | head -c 300
```

**é¢„æœŸæ—¥å¿—**:
```
[ONVIF] ğŸ“‹ GetCapabilities è¯·æ±‚: ç«¯ç‚¹=...
[ONVIF] ğŸ“ è¿›å…¥ <Media> éƒ¨åˆ†
[ONVIF] âœ… å‘ç°åª’ä½“æœåŠ¡åœ°å€: ...
[ONVIF] â„¹ï¸ mediaAddr æœªè®¾ç½®ï¼Œè°ƒç”¨ GetCapabilities
[ONVIF] âœ… ä½¿ç”¨ Media.XAddr: ...
[ONVIF] ğŸ“¡ GetProfiles è¯·æ±‚è¯¦æƒ… | Endpoint=... | Username=...
[ONVIF] âœ… æˆåŠŸè·å– N ä¸ªåª’ä½“é…ç½®æ–‡ä»¶
```

### æ­¥éª¤ 4: API ç«¯ç‚¹æµ‹è¯•
```bash
# è·å–è®¾å¤‡åˆ—è¡¨
curl -s http://localhost:8080/api/onvif/devices | jq .

# è·å– Profiles
curl -s http://localhost:8080/api/onvif/devices/192.168.1.250:8888/profiles | jq .
```

**é¢„æœŸ**: è¿”å›æœ‰æ•ˆçš„ JSON æ•°æ®ï¼ŒåŒ…å«è®¾å¤‡å’Œé…ç½®ä¿¡æ¯

---

## ğŸ” æ•…éšœæ’æŸ¥

å¦‚æœæµ‹è¯•å¤±è´¥ï¼Œæ£€æŸ¥ä»¥ä¸‹å†…å®¹:

### æƒ…å†µ 1: ç¼–è¯‘å¤±è´¥
```
âŒ ç¼–è¯‘å‡ºé”™
```
**æ£€æŸ¥**: ä»£ç æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯
```bash
go build -o server ./cmd/server/ 2>&1 | head -20
```

### æƒ…å†µ 2: è„šæœ¬æ–¹å¼æˆåŠŸä½† Go æ–¹å¼å¤±è´¥
```
ã€1ï¸âƒ£ è„šæœ¬æ–¹å¼æµ‹è¯•ã€‘
âœ… è„šæœ¬æ–¹å¼æˆåŠŸ (HTTP 200)

ã€2ï¸âƒ£ Go æœåŠ¡æµ‹è¯•ã€‘
âŒ Go æ–¹å¼å¤±è´¥ (HTTP 503)
   å“åº”: ...
```

**å¯èƒ½åŸå› **:
- è¯·æ±‚ä½“æ ¼å¼ä»æœ‰å·®å¼‚
- æ—¶é—´æˆ³æ ¼å¼ä¸å¯¹

**æ£€æŸ¥**:
```bash
./server 2>&1 | grep "SOAPè¯·æ±‚ä½“é¢„è§ˆ" | head -1
# å¯¹æ¯”è¾“å‡ºä¸è„šæœ¬æ–¹å¼
```

### æƒ…å†µ 3: æœåŠ¡å´©æºƒ
```
[1]    12345 segmentation fault  ./server
```

**æ£€æŸ¥**:
- å†…å­˜æ³„æ¼
- ç©ºæŒ‡é’ˆè®¿é—®
```bash
go run ./cmd/server/ 2>&1 | tail -20
```

---

## ğŸ“Š æ€§èƒ½æ£€æŸ¥

ä¿®å¤åéªŒè¯æ€§èƒ½æœªä¸‹é™:

```bash
# æµ‹è¯•å“åº”æ—¶é—´
time curl -s http://localhost:8080/api/onvif/devices/192.168.1.250:8888/profiles > /dev/null
```

**é¢„æœŸ**: å“åº”æ—¶é—´ < 5 ç§’

---

## âœ… æœ€ç»ˆéªŒæ”¶æ ‡å‡†

ä¿®å¤æˆåŠŸçš„æ ‡å¿—:

- [ ] âœ… ç¼–è¯‘æ— é”™è¯¯
- [ ] âœ… è„šæœ¬æ–¹å¼å’Œ Go æ–¹å¼éƒ½è¿”å› HTTP 200
- [ ] âœ… GetSystemDateAndTime æˆåŠŸè¿”å›
- [ ] âœ… GetProfiles è¿”å›é…ç½®æ–‡ä»¶åˆ—è¡¨
- [ ] âœ… æ—¥å¿—æ˜¾ç¤º "æˆåŠŸè·å– N ä¸ªåª’ä½“é…ç½®æ–‡ä»¶"
- [ ] âœ… API ç«¯ç‚¹è¿”å›æœ‰æ•ˆæ•°æ®
- [ ] âœ… å“åº”æ—¶é—´æ­£å¸¸ï¼ˆ< 5 ç§’ï¼‰

---

## ğŸ“ è®°å½•

å®Œæˆæ‰€æœ‰éªŒè¯åï¼Œè®°å½•:

**æ—¥æœŸ**: ________________
**è®¾å¤‡ IP**: ________________
**ç»“æœ**: ________________

**æµ‹è¯•æ—¥å¿—**:
```
ï¼ˆç²˜è´´éªŒè¯ç»“æœï¼‰
```

---

## ğŸ“ éœ€è¦å¸®åŠ©?

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æä¾›:

1. å®Œæ•´ç¼–è¯‘è¾“å‡º:
   ```bash
   go build -o server ./cmd/server/ 2>&1
   ```

2. å®Œæ•´çš„é”™è¯¯æ—¥å¿—:
   ```bash
   ./server 2>&1 | tail -50
   ```

3. API å“åº”:
   ```bash
   curl -s http://localhost:8080/api/onvif/devices/192.168.1.250:8888/profiles | head -c 500
   ```

4. è„šæœ¬æµ‹è¯•ç»“æœ:
   ```bash
   ./quick_test.sh 192.168.1.250 8888 admin a123456789
   ```
