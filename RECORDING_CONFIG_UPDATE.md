# 录像配置前端更新说明

## 更新日期
2025-12-07

## 更新内容

### 前端页面更新 (frontend/src/views/Settings.vue)

在"设置"页面的"录像"标签页中，新增了以下配置项：

#### 1. 基本配置
- **录像目录** (`RecordPath`)
  - 类型：文本输入框
  - 默认值：`./recordings`
  - 说明：录像文件的保存路径，建议使用持久化目录

- **应用名称** (`AppName`)
  - 类型：文本输入框
  - 默认值：`record`
  - 说明：录像应用的名称，用于路径分类

#### 2. 录像分割配置
- **按时间分割(秒)** (`FileSecond`)
  - 类型：数字输入框
  - 范围：0 - 86400 秒
  - 步进：300 秒 (5分钟)
  - 默认值：3600 秒 (1小时)
  - 说明：
    - 0 = 不分割
    - 3600 = 每小时分割一次
    - 1800 = 每半小时分割一次
  - 提示：防止单个录像文件过大，便于管理和检索

- **按大小分割(MB)** (`FileSizeMB`)
  - 类型：数字输入框
  - 范围：0 - 10240 MB
  - 步进：100 MB
  - 默认值：0 (不限制)
  - 说明：
    - 0 = 不限制文件大小
    - 建议值：500-1000MB
  - 提示：当文件达到指定大小时自动分割

#### 3. 高级选项
- **采样间隔(ms)** (`SampleMS`)
  - 类型：数字输入框
  - 范围：100 - 5000 毫秒
  - 默认值：500 毫秒
  - 说明：录像采样的时间间隔

- **快速启动** (`FastStart`)
  - 类型：开关
  - 默认值：关闭
  - 说明：启用MP4 FastStart模式，优化文件结构以支持流式播放

- **启用FMP4** (`EnableFmp4`)
  - 类型：开关
  - 默认值：关闭
  - 说明：启用分段MP4格式，适合HLS流式传输

## 文件命名规则

录像文件按以下格式保存：
```
{RecordPath}/{AppName}/{ChannelID}/{Date}/YYYY-MM-DD-HH-MM-SS-{index}.mp4
```

示例：
```
./recordings/record/34020000001320000001/20251207/2025-12-07-14-30-00-0.mp4
```

## 配置文件映射

前端配置项与 `configs/config.yaml` 的映射关系：

```yaml
ZLM:
  Record:
    RecordPath: "./recordings"      # 录像目录
    AppName: "record"               # 应用名称
    FileSecond: 3600                # 按时间分割(秒)
    FileSizeMB: 0                   # 按大小分割(MB)
    SampleMS: 500                   # 采样间隔
    FastStart: false                # 快速启动
    EnableFmp4: false               # 启用FMP4
```

## 使用建议

### 时间分割策略
- **监控场景**：建议设置为 3600 秒（1小时），便于按小时检索
- **高清录像**：建议设置为 1800 秒（30分钟），防止单文件过大
- **连续录像**：可设置为 7200 秒（2小时）或更长

### 大小分割策略
- **标清视频** (720p)：建议 500MB
- **高清视频** (1080p)：建议 1000MB
- **超清视频** (4K)：建议 2000-3000MB

### 组合策略
建议同时设置时间和大小限制，哪个条件先满足就按哪个分割：
- FileSecond: 3600 (1小时)
- FileSizeMB: 1000 (1GB)

## 后端支持

### ZLM配置生成
后端会自动将前端配置转换为 ZLM 的 `config.ini` 配置：

```ini
[record]
appName=record
filePath=./recordings
fileSecond=3600
fileSizeMB=0
sampleMS=500
fastStart=0
enableFmp4=0
```

### 存储管理
系统的存储管理功能会监控录像目录的磁盘使用情况：
- 支持多磁盘RAID配置
- 支持循环录像（自动删除旧文件）
- 支持按时间/大小/数量的清理策略

## 测试方法

1. **访问设置页面**
   ```
   http://localhost:9080
   点击"设置" -> "ZLM配置" -> "录像"标签页
   ```

2. **修改配置**
   - 修改"按时间分割"为 1800 秒
   - 修改"按大小分割"为 500 MB
   - 点击"保存配置"

3. **重启服务**
   ```bash
   pkill -f ./server
   ./server &
   ```

4. **验证配置**
   ```bash
   # 查看API配置
   curl http://localhost:9080/api/config | grep -A 10 '"Record"'
   
   # 查看ZLM配置文件
   cat third-party/zlm/conf/config.ini | grep -A 10 '\[record\]'
   ```

5. **测试录像**
   - 启动一路GB28181设备录像
   - 观察录像文件是否按设定时间或大小分割
   - 检查文件命名格式是否正确

## 注意事项

1. **录像目录权限**
   - 确保录像目录有足够的读写权限
   - 建议使用绝对路径或相对于服务启动目录的路径

2. **磁盘空间**
   - 定期检查磁盘空间使用情况
   - 配合存储管理的循环录像功能
   - 建议设置磁盘使用率告警阈值

3. **性能影响**
   - 文件分割会产生短暂的I/O操作
   - 建议在非关键录像时段测试分割参数
   - 过于频繁的分割可能影响录像质量

4. **文件管理**
   - 分割后的文件需要统一管理
   - 建议使用录像回放功能检索
   - 删除录像时注意不要误删正在写入的文件

## 相关功能

- **录像回放**：`/home/julei/zpip/frontend/src/views/RecordingPlayback.vue`
- **存储管理**：`/home/julei/zpip/internal/storage/disk_manager.go`
- **录像API**：`/api/recordings` - 录像列表查询
- **存储API**：`/api/storage/disks` - 磁盘状态查询

## 版本历史

- **v1.0** (2025-12-07)
  - 初始版本
  - 添加录像目录配置
  - 添加时间和大小分割配置
  - 添加高级选项（FastStart、FMP4）
  - 添加配置说明和提示信息
